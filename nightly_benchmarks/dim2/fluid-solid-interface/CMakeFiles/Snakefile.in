SPECFEM_BIN = "@CMAKE_BINARY_DIR@/bin/specfem2d"
MESHFEM_BIN = "@CMAKE_BINARY_DIR@/bin/xmeshfem2D"

rule generate_mesh:
    input:
        "@CURRENT_BENCHMARK_BUILD_DIR@/Par_File",
    output:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
    localrule: True
    shell:
        """
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
            {MESHFEM_BIN} -p {input}
        """


rule run_solver:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="@CURRENT_BENCHMARK_BUILD_DIR@/sources.yaml",
        config="@CURRENT_BENCHMARK_BUILD_DIR@/specfem_config.yaml",
    output:
        seismograms=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/{network_name}.{station_name}.S2.{component}.semd",
            station_name=[
                "S0001",
                "S0002",
                "S0003",
                "S0004",
                "S0005",
                "S0006",
                "S0007",
                "S0008",
                "S0009",
                "S0010",
                "S0011",
            ],
            network_name=["AA"],
            component=["BXX", "BXZ"],
        ),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/output.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    params:
        KOKKOS_TOOLS_LIBS='""',
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results
            export KOKKOS_TOOLS_LIBS={params.KOKKOS_TOOLS_LIBS}
            echo "Hostname: $(hostname)" > {output.log}
            {SPECFEM_BIN} -p {input.config} >> {output.log}
        """

rule clean:
    shell:
        """
            rm -rf @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
        """

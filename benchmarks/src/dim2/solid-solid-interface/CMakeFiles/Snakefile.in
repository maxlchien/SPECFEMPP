SPECFEM_BIN = "@CMAKE_BINARY_DIR@/bin/specfem 2d"
MESHFEM_BIN = "@CMAKE_BINARY_DIR@/bin/xmeshfem2D"

rule all:
    input:
        plot_psv="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_psv/plot.png",
        plot_sh="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_sh/plot.png",
    localrule: True


rule generate_mesh:
    input:
        "@CURRENT_BENCHMARK_BUILD_DIR@/Par_File",
    output:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
    localrule: True
    shell:
        """
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
            {MESHFEM_BIN} -p {input}
        """


rule run_solver_psv:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="@CURRENT_BENCHMARK_BUILD_DIR@/source.yaml",
        config="@CURRENT_BENCHMARK_BUILD_DIR@/specfem_config_psv.yaml",
    output:
        seismograms=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_psv/{network_name}.{station_name}.S2.{component}.semd",
            station_name=["S0001",], network_name=["AA"], component=["BXX", "BXZ"],
        ),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/output_psv.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_psv
            {SPECFEM_BIN} -p {input.config}
        """


rule plot_seismogram_psv:
    input:
        trace_files=rules.run_solver_psv.output.seismograms,
    output:
        traces="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_psv/plot.png",
    localrule: True
    run:
        import glob
        import os
        import numpy as np
        import obspy

        # Set matplotlib gui off
        import matplotlib
        matplotlib.use("Agg")

        def get_traces(directory):
            traces = []
            files = glob.glob(directory + "/*.sem*")

            # iterate over all seismograms

            for filename in files:
                station_name = os.path.splitext(filename)[0]
                network, station, location, channel = station_name.split("/")[-1].split(".")
                trace = np.loadtxt(filename, delimiter=" ")
                starttime = trace[0, 0]
                dt = trace[1, 0] - trace[0, 0]
                traces.append(
                    obspy.Trace(
                        trace[:, 1],
                        dict(network=network,
                            station=station,
                            location=location,
                            channel=channel,
                            starttime=starttime,
                            delta=dt)
                    )
                )

            stream = obspy.Stream(traces)

            return stream

        # Get traces from the specified directory
        directory_name = "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_psv"
        stream = get_traces(directory_name)

        stream.plot(size=(1000, 600)).savefig(output.traces)



rule run_solver_sh:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="@CURRENT_BENCHMARK_BUILD_DIR@/source.yaml",
        config="@CURRENT_BENCHMARK_BUILD_DIR@/specfem_config_sh.yaml",
    output:
        seismograms=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_sh/{network_name}.{station_name}.S2.{component}.semd",
            station_name=[
                "S0001",
            ],
            network_name=["AA"],
            component=["BXY"],
        ),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/output_sh.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_sh
            {SPECFEM_BIN} -p {input.config}
        """

rule plot_seismogram_sh:
    input:
        trace_files=rules.run_solver_sh.output.seismograms,
    output:
        traces="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_sh/plot.png",
    localrule: True
    run:
        import glob
        import os
        import numpy as np
        import obspy

        # Set matplotlib gui off
        import matplotlib
        matplotlib.use("Agg")


        def get_traces(directory):
            traces = []
            files = glob.glob(directory + "/*.sem*")
            # iterate over all seismograms
            for filename in files:
                station_name = os.path.splitext(filename)[0]
                network, station, location, channel = station_name.split("/")[-1].split(".")
                trace = np.loadtxt(filename, delimiter=" ")
                starttime = trace[0, 0]
                dt = trace[1, 0] - trace[0, 0]
                traces.append(
                    obspy.Trace(
                        trace[:, 1],
                        dict(network=network,
                            station=station,
                            location=location,
                            channel=channel,
                            starttime=starttime,
                            delta=dt)
                    )
                )

            stream = obspy.Stream(traces)

            return stream

        directory_name = "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results_sh"
        stream = get_traces(directory_name)
        stream.plot(size=(1000, 400)).savefig(output.traces)





rule clean:
    shell:
        """
            rm -rf @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
        """

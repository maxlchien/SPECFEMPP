SPECFEM_BIN = "@CMAKE_BINARY_DIR@/bin/specfem 2d"
MESHFEM_BIN = "@CMAKE_BINARY_DIR@/bin/xmeshfem2D"
ADJ_SEISMOGRAM_BIN = "@CMAKE_BINARY_DIR@/bin/xadj_seismogram"


rule all:
    input:
        kernels="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/Kernels.png",


rule generate_mesh:
    input:
        "@CURRENT_BENCHMARK_BUILD_DIR@/Par_File",
    output:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
    localrule: True
    shell:
        """
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
            {MESHFEM_BIN} -p {input}
        """


rule forward_simulation:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="@CURRENT_BENCHMARK_BUILD_DIR@/forward_source.yaml",
        config="@CURRENT_BENCHMARK_BUILD_DIR@/forward_config.yaml",
    output:
        seismograms=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/{network_name}.{station_name}.S2.{component}.semd",
            station_name=["S0001"],
            network_name=["AA"],
            component=["BXX", "BXZ"],
        ),
        forward_wavefield=directory("@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/ForwardWavefield"),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/output_forward.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results
            {SPECFEM_BIN} -p {input.config}
        """


rule compute_adjoint_sources:
    input:
        seismograms=rules.forward_simulation.output.seismograms,
    output:
        adjoint_sources=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/adjoint_sources/{network_name}.{station_name}.S2.{component}.adj",
            station_name=["S0001"],
            network_name=["AA"],
            component=["BXX", "BXZ"],
        ),
    shell:
        """
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/adjoint_sources
            {ADJ_SEISMOGRAM_BIN} 27.0 32.0 AA.S0001.S2 @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/ @CURRENT_BENCHMARK_BUILD_DIR@/adjoint_sources/ 1
        """


rule adjoint_simulation:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="@CURRENT_BENCHMARK_BUILD_DIR@/adjoint_source.yaml",
        config="@CURRENT_BENCHMARK_BUILD_DIR@/adjoint_config.yaml",
        adjoint_sources=rules.compute_adjoint_sources.output.adjoint_sources,
    output:
        kernels=directory("@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/Kernels"),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/output_adjoint.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results
            {SPECFEM_BIN} -p {input.config}
        """


rule plot_kernels:
    input:
        kernels="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/Kernels",
        plot_script="@CURRENT_BENCHMARK_BUILD_DIR@/plot.py",
    output:
        plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/Kernels.png",
    run:
        from plot import plot_kernels

        # Set matplotlib gui off
        import matplotlib
        matplotlib.use("Agg")

        plot_kernels(input.kernels, output.plot)


rule clean:
    shell:
        """
            rm -rf @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES @CURRENT_BENCHMARK_BUILD_DIR@/adjoint_sources
        """

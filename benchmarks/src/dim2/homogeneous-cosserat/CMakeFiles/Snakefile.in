SPECFEM_BIN = "@CMAKE_BINARY_DIR@/bin/specfem 2d"
MESHFEM_BIN = "@CMAKE_BINARY_DIR@/bin/xmeshfem2D"

rule all:
    input:
        unified_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/unified_traces.png",
        geometry_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/geometry.png",
        comparison_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/reference_comparison.png"
    localrule: True


rule generate_mesh:
    input:
        "Par_File",
    output:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
    localrule: True
    shell:
        """
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
            {MESHFEM_BIN} -p {input}
        """



rule run_solver:
    input:
        database="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/database.bin",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="source.yaml",
        config="specfem_config.yaml",
    output:
        seismograms=expand(
            "@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/{network_name}.{station_name}.S2.{component}",
            station_name=["S0001", "S0002", "S0003", "S0004", "S0005", "S0006", "S0007", "S0008"],
            network_name=["AA"],
            component=["BXX.semd", "BXZ.semd", "BXY.semr", "BXY.semir", "BXY.semc"],
        ),
        log="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/output.log",
    resources:
        nodes=1,
        tasks=1,
        cpus_per_task=1,
        runtime=10,
    shell:
        """
            # module purge
            # module load boost/1.73.0
            mkdir -p @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results
            {SPECFEM_BIN} -p {input.config}
        """


rule plot_seismogram:
    input:
        trace_files=rules.run_solver.output.seismograms,
        plot_script="plot_seismograms.py",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="source.yaml"
    output:
        unified_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/unified_traces.png"
    localrule: True
    shell:
        "python {input.plot_script} {output.unified_plot}"


rule plot_geometry:
    input:
        plot_script="plot_geometry.py",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="source.yaml",
        topography="topography.dat"
    output:
        geometry_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/geometry.png"
    localrule: True
    shell:
        "python {input.plot_script} {output.geometry_plot}"


rule plot_reference_comparison:
    input:
        plot_script="plot_reference_comparison.py",
        stations="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/STATIONS",
        source="source.yaml",
        seismograms=rules.run_solver.output.seismograms,
        reference_ux="reference/traces_fd/ux.npy",
        reference_uz="reference/traces_fd/uz.npy",
        reference_ry="reference/traces_fd/ry.npy"
    output:
        comparison_plot="@CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES/results/reference_comparison.png"
    localrule: True
    shell:
        "python {input.plot_script} {output.comparison_plot}"


rule clean:
    localrule: True
    shell:
        """
            rm -rf @CURRENT_BENCHMARK_BUILD_DIR@/OUTPUT_FILES
        """

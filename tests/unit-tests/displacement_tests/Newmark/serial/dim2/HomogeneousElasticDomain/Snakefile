include: "specfem2d.smk"


stations = [f"S{i:04d}" for i in range(1, 21)]
seismograms = {"BXX": ["semd", "semv", "sema"], "BXZ": ["semd", "semv", "sema"], "PRE": ["semp"]}

traces_specfem2d = [
    f"{specfem_workdir}/OUTPUT_FILES/AA.{station}.{component}.{seismogram}"
    for station in stations
    for component in seismograms.keys()
    for seismogram in seismograms[component]
]

traces = [
    f"{current_workdir}/traces/AA.{station}.S2.{component}.{seismogram}"
    for station in stations
    for component in seismograms.keys()
    for seismogram in seismograms[component]
]


rule all:
    input:
        traces=traces,
        trace_list=f"{current_workdir}/traces/trace_list.txt",
    localrule: True


rule run_solver:
    input:
        specfem_solver_output=f"{specfem_workdir}/OUTPUT_FILES/output_solver.txt",
    output:
        traces=traces_specfem2d,


rule collect_traces:
    input:
        traces=traces_specfem2d,
    output:
        traces=traces,
        trace_list=f"{current_workdir}/traces/trace_list.txt",
    localrule: True
    run:
        import os
        os.makedirs("traces", exist_ok=True)

        for i in range(len(input.traces)):
            infile = input.traces[i]
            outfile = output.traces[i]
            shell(f"mv {infile} {outfile}")

        with open(output.trace_list, "w") as f:
            for trace in output.traces:
                f.write(f"{trace[7:]}\n")

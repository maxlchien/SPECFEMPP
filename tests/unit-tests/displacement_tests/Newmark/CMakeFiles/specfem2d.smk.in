envvars:
    "SPECFEM2D_BINDIR"

current_workdir = "@CMAKE_CURRENT_SOURCE_DIR@"


rule specfem2d_setup:
    input:
        par_file=f"{current_workdir}/provenance/Par_file",
        source=f"{current_workdir}/provenance/SOURCE",
        topography=f"{current_workdir}/provenance/topography.dat",
    output:
        workdir=directory(f"{current_workdir}/specfem2d_workdir"),
        par_file=f"{current_workdir}/specfem2d_workdir/DATA/Par_file",
        source=f"{current_workdir}/specfem2d_workdir/DATA/SOURCE",
        topography=f"{current_workdir}/specfem2d_workdir/DATA/topography.dat",
    localrule: True,
    shell:
        """
            cp {input.par_file} {output.par_file}
            cp {input.source} {output.source}
            cp {input.topography} {output.topography}
        """


rule specfem2d_mesher:
    input:
        setup=rules.specfem2d_setup.output,
        workdir=rules.specfem2d_setup.output.workdir,
    output:
        database=f"{current_workdir}/specfem2d_workdir/OUTPUT_FILES/Database00000.bin",
        stations=f"{current_workdir}/specfem2d_workdir/DATA/STATIONS",
        mesher=f"{current_workdir}/specfem2d_workdir/OUTPUT_FILES/output_mesher.txt",
    shell:
        """
            cd {input.workdir}
            $SPECFEM2D_BINDIR/xmeshfem2D > {output.mesher}
        """


rule specfem2d_solver:
    input:
        setup=rules.specfem2d_setup.output,
        mesher=rules.specfem2d_mesher.output,
        workdir=rules.specfem2d_setup.output.workdir,
    output:
        solver = f"{rules.specfem2d_setup.output.workdir}/OUTPUT_FILES/output_solver.txt"
    shell:
        """
            cd {input.workdir}
            $SPECFEM2D_BINDIR/xspecfem2D > {output.solver}
        """


rule specfem2d_move_traces:
    input:
        rules.specfem2d_solver.output.solver,
    output:
        trace_list=f"{current_workdir}/traces/trace_list.txt",
    localrule: True,
    run:
        import os
        os.makedirs("@CMAKE_CURRENT_SOURCE_DIR@/traces", exist_ok=True)

        trace_list = []

        for trace_file in os.listdir(f"{current_workdir}/specfem2d_workdir/OUTPUT_FILES/"):
            trace_file_split = trace_file.split(".")
            if len(trace_file_split) == 4 and trace_file_split[-1].startswith("sem"):
                trace_file_out = ".".join([trace_file_split[0], trace_file_split[1], "S2", trace_file_split[2], trace_file_split[3]])
                trace_list.append(trace_file_out + "\n")
                infile = os.path.join(f"{current_workdir}/specfem2d_workdir/OUTPUT_FILES/", trace_file)
                outfile = os.path.join(f"{current_workdir}/traces/", trace_file_out)
                shell(f"mv {infile} {outfile}")

        with open(output.trace_list, "w") as f:
            f.writelines(trace_list)


rule clean:
    localrule: True
    shell:
        """
            rm -rf {current_workdir}/specfem2d_workdir
            rm -rf {current_workdir}/traces
        """
